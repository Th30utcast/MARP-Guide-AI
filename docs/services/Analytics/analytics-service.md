# Service Name: Analytics Service

## Responsibility

Consumes user interaction events from RabbitMQ and provides analytics API for querying system usage metrics.

## Data Owned

- User query events (in-memory storage)
- Response generation events (in-memory storage)
- Model comparison events (in-memory storage)
- Feedback events (in-memory storage, ready for future implementation)
- Citation click events (in-memory storage, ready for future implementation)
- Model selection events (in-memory storage, ready for future implementation)

## API Endpoints

- [GET] /analytics/summary - Aggregate analytics metrics
- [GET] /analytics/popular-queries - Most frequently asked questions
- [GET] /analytics/model-stats - Performance statistics per LLM model
- [GET] /analytics/recent-queries - Recent user queries
- [POST] /analytics/reset - Clear all analytics data (development only)
- [GET] /health - Health check endpoint

## Analytics Service API

### GET /analytics/summary

Get aggregated analytics metrics

**Headers:**
```
Authorization: Bearer <session_token>
```

**Query Parameters:**
- `user_id` (optional) - Required for non-admin users to filter personal data

**Response: 200 OK**

```json
{
  "total_queries": 142,
  "total_responses": 142,
  "total_feedback": 37,
  "total_comparisons": 15,
  "avg_latency_ms": 1247.35,
  "avg_citations_per_response": 2.8
}
```

**Errors:**
- 400 Bad Request - Non-admin user missing `user_id` parameter
- 401 Unauthorized - Missing authorization header

**Access Control:**
- **Admin users:** See global statistics across all users
- **Regular users:** Must provide `user_id`, see only their own data

**Logged Metrics:**
- Admin viewing global analytics: `üìä Admin viewing global analytics (142 total queries)`
- User viewing personal analytics: `üìä User {user_id} viewing personal analytics (15 queries)`

---

### GET /analytics/popular-queries

Get most frequently asked questions

**Headers:**
```
Authorization: Bearer <session_token>
```

**Query Parameters:**
- `user_id` (optional) - Required for non-admin users
- `limit` (optional, default: 10) - Maximum results (1-100)

**Response: 200 OK**

```json
[
  {
    "query": "What happens if I am ill during exams?",
    "count": 28
  },
  {
    "query": "How do I appeal my grade?",
    "count": 19
  },
  {
    "query": "What is the exam policy?",
    "count": 15
  }
]
```

**Errors:**
- 400 Bad Request - Non-admin user missing `user_id`
- 401 Unauthorized - Missing authorization header

**Access Control:**
- Admin users see global popular queries
- Regular users see only their own query history

**Ordering:**
- Results sorted by count (descending)
- Limited to top N results based on `limit` parameter

---

### GET /analytics/model-stats

Get performance statistics per LLM model

**Headers:**
```
Authorization: Bearer <session_token>
```

**Query Parameters:**
- `user_id` (optional) - Required for non-admin users

**Response: 200 OK**

```json
[
  {
    "model_id": "google/gemma-3n-e2b-it:free",
    "total_queries": 87,
    "avg_latency_ms": 1189.45,
    "total_citations": 243
  },
  {
    "model_id": "meta-llama/llama-3.2-3b-instruct:free",
    "total_queries": 42,
    "avg_latency_ms": 1456.78,
    "total_citations": 118
  },
  {
    "model_id": "microsoft/phi-3-mini-128k-instruct:free",
    "total_queries": 13,
    "avg_latency_ms": 892.34,
    "total_citations": 35
  }
]
```

**Errors:**
- 400 Bad Request - Non-admin user missing `user_id`
- 401 Unauthorized - Missing authorization header

**Metrics:**
- `total_queries` - Number of responses generated by this model
- `avg_latency_ms` - Average response generation time
- `total_citations` - Total citations across all responses

**Access Control:**
- Admin users see global model statistics
- Regular users see statistics from their own usage

---

### GET /analytics/recent-queries

Get recent user queries with metadata

**Headers:**
```
Authorization: Bearer <session_token>
```

**Query Parameters:**
- `user_id` (optional) - Required for non-admin users
- `limit` (optional, default: 10) - Maximum results (1-100)

**Response: 200 OK**

```json
[
  {
    "query": "What is the grade appeal process?",
    "timestamp": "2025-12-10T15:30:45Z",
    "model_id": "google/gemma-3n-e2b-it:free",
    "session_id": "session-abc-123"
  },
  {
    "query": "What happens if I am ill during exams?",
    "timestamp": "2025-12-10T15:25:12Z",
    "model_id": "meta-llama/llama-3.2-3b-instruct:free",
    "session_id": "session-abc-123"
  }
]
```

**Errors:**
- 400 Bad Request - Non-admin user missing `user_id`
- 401 Unauthorized - Missing authorization header

**Ordering:**
- Most recent queries first (reverse chronological)
- Limited to last N queries based on `limit` parameter

**Access Control:**
- Admin users see all recent queries
- Regular users see only their own queries

---

### POST /analytics/reset

Clear all analytics data (development/testing only)

**Authentication:** ‚ùå Not required

**Response: 200 OK**

```json
{
  "status": "success",
  "message": "All analytics data has been reset",
  "cleared": {
    "queries": true,
    "responses": true,
    "feedback": true,
    "citation_clicks": true,
    "model_comparisons": true,
    "model_selections": true
  }
}
```

**‚ö†Ô∏è Warning:**
- Clears all in-memory event storage
- Cannot be undone
- Use only in development/testing environments

**Logged:**
- `üîÑ Analytics data reset - all events cleared`

---

### GET /health

Health check endpoint

**Response: 200 OK**

```json
{
  "status": "healthy",
  "service": "analytics"
}
```

---

## Events Consumed

### QuerySubmitted

Tracks user queries for analytics

**Queue:** `analytics_query_submitted`
**Routing Key:** `analytics.query.submitted`

**Event Schema:**
```json
{
  "eventType": "QuerySubmitted",
  "eventId": "uuid",
  "timestamp": "ISO-8601",
  "correlationId": "uuid",
  "source": "chat-service",
  "version": "1.0",
  "payload": {
    "query": "string",
    "userSessionId": "string",
    "modelId": "string",
    "userId": "string (optional)"
  }
}
```

**Handler:** `handle_query_submitted()`

**Action:**
- Stores event in `query_events` list
- Logs query (truncated to 50 characters)

---

### ResponseGenerated

Tracks generated responses with metrics

**Queue:** `analytics_response_generated`
**Routing Key:** `analytics.response.generated`

**Event Schema:**
```json
{
  "eventType": "ResponseGenerated",
  "eventId": "uuid",
  "timestamp": "ISO-8601",
  "correlationId": "uuid",
  "source": "chat-service",
  "version": "1.0",
  "payload": {
    "query": "string",
    "response": "string",
    "modelId": "string",
    "userSessionId": "string",
    "latencyMs": "float",
    "citationCount": "integer",
    "retrievalCount": "integer",
    "userId": "string (optional)"
  }
}
```

**Handler:** `handle_response_generated()`

**Action:**
- Stores event in `response_events` list
- Logs model ID and latency

---

### ModelComparisonTriggered

Tracks multi-model comparison usage

**Queue:** `analytics_model_comparison`
**Routing Key:** `analytics.model.comparison.triggered`

**Event Schema:**
```json
{
  "eventType": "ModelComparisonTriggered",
  "eventId": "uuid",
  "timestamp": "ISO-8601",
  "correlationId": "uuid",
  "source": "chat-service",
  "version": "1.0",
  "payload": {
    "query": "string",
    "userSessionId": "string",
    "models": ["string", ...],
    "userId": "string (optional)"
  }
}
```

**Handler:** `handle_model_comparison_triggered()`

**Action:**
- Stores event in `model_comparison_events` list
- Logs number of models compared

---

### Planned Events (Handlers Ready)

The following event handlers are implemented but not yet emitted by producer services:

**FeedbackReceived** - Queue: `analytics_feedback_received`, Routing Key: `analytics.feedback.received`
**CitationClicked** - Queue: `analytics_citation_clicked`, Routing Key: `analytics.citation.clicked`
**ModelSelected** - Queue: `analytics_model_selected`, Routing Key: `analytics.model.selected`

---

## Technical Details

**Storage:**
- In-memory Python lists (not persisted to database)
- Data lost on service restart
- Sufficient for demonstration and development
- Production would use PostgreSQL or time-series database

**Event Consumption:**
- Uses RabbitMQ message broker
- Topic exchange: `events`
- Durable queues with manual acknowledgment
- Each event type has dedicated queue and handler
- Handlers run in separate daemon threads

**Authentication Integration:**
- Validates admin status via Auth Service
- Makes HTTP call to `/auth/validate` endpoint
- Checks `is_admin` field in response
- Non-admin users must provide `user_id` parameter

**Error Handling:**
- Failed event processing: logs error, sends NACK (no requeue)
- Auth validation failure: returns appropriate HTTP error
- Safe dictionary access with `.get()` for defensive programming

**Startup Behavior:**
- Consumer threads started in `startup_event()`
- Queues declared and bound to exchange
- Multiple consumers (one per event type)

**Dependencies:**
- RabbitMQ for event consumption
- Auth Service for session validation
- No database required (in-memory storage)

---

## Service Integration

**Called By:**
- Web UI (analytics dashboard, admin panel)

**Consumes Events From:**
- Chat Service (QuerySubmitted, ResponseGenerated, ModelComparisonTriggered)

**Depends On:**
- RabbitMQ (event broker)
- Auth Service (session validation)

**Network Communication:**
- HTTP REST API on port 8005
- RabbitMQ AMQP connection on port 5672
- HTTP client to Auth Service (session validation)
